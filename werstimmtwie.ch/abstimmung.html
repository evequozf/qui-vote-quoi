<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="index, follow" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css"> 
<link rel="stylesheet" href="http://www.quivotequoi.ch/custom.css"> 
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

<title>Verfassungsrat: Abstimmungsresultat</title>

<!------------------------

Pour r√©utilisation GC -> enlever "partisOrder" et remplacer le domain de l'axe x par "groups" ?

ajouter voteDescription=true

----------------->

</head>
<body>

<div class="banner-image">
  <div class="banner-text">
    <!-- <h1>üó≥Ô∏è <span class="smallcaps">Qui vote quoi ? </span>üó≥Ô∏è</h1> -->
   <div class="right-banner">
      <a href="http://www.werstimmtwie.ch/index.html"> <h1>WER STIMMT WIE?<br/><span style="font-size: smaller;">Abstimmungsresultate im Verfassungsrat des Kanton Wallis</span></h1></a>
    </div>
    <div class="left-banner">
      <a href="http://www.quivotequoi.ch/index.html" id="language-fr">FR</a> | <a class="selected" href="http://www.werstimmtwie.ch/index.html" id="language-de">DE</a>
    </div>
  </div>
</div>

<div class="header">
  <div class="back"><a class="link" href="index.html"> &lt; Zur√ºck zur Liste der Abstimmungen</a></div>
  <div class="navigate-votes"><a class="link" id="previousVote" href="#"> &lt; Vorherige Abstimmung</a> | <a class="link" id="nextVote" href="#">N√§chste Abstimmung &gt; </a></div>
</div>

<div class="container">

<h1 id="affair"></h1>

<!--<div id="vote-metadata">
  
</div>-->

<div id="note"></div>

<div id="warning">
<p class="title"> Diese Abstimmung mag WIDERSPR√úCHLICH erscheinen </p> <!-- ‚ö†Ô∏è -->
<p><span id="warning-text"></span>, war es notwendig mit <span class="pd-color-no">NEIN</span> zu stimmen.</p>
</div>

<span id="toggle-help">Interpretation dieser Abstimmung</span>
<div id="help"><p>Die Mitglieder des Verfassungsrates stimmen √ºber jeden einzelnen Artikel der zuk√ºnftigen Verfassung ab. Es stehen immer zwei Varianten zur Auswahl. Ausser es gibt keine Ab√§nderungsantr√§ge. Mit <span class="pd-color-yes">JA</span> stimmen bedeutet, sich f√ºr eine der beiden Varianten zu entscheiden. Wenn man <span class="pd-color-no">NEIN</span> stimmt,entscheidet man sich f√ºr die andere. Man kann sich auch der Stimme enthalten, indem man <span class="pd-color-abstain">ENTH</span> stimmt.</p><p>Die Bedeutung von <span class="pd-color-yes">JA</span> und <span class="pd-color-no">NEIN</span> wird, falls m√∂glich, unter dem Ergebnis angegeben. Zu finden ist die Bedeutung auch in den <a class="link refdoc" href="">Details zu den Artikeln und Ab√§nderungsantr√§gen</a>, √ºber die abgestimmt wurde. Der offizielle Hinweis zu der Abstimmung, der √ºber dem Ergebnis angegeben ist, erm√∂glicht es, den betreffenden Artikel beziehungsweise Ab√§nderungsantrag zu finden.</p></div>


            <div id="pd-vote-bar">

              <div class="vote-metadata"></div>
              <div class="clearfix"> </div>

                <!-- Graduation 50% -->
                <div class="pd-vb-bar" style="background-color:white;text-align: center;color: #aaa;margin-bottom: -5px;">50%</div>
                <div class="clearfix"> </div>

                <!-- Graduation 50% mark -->
                <div class="pd-vb-bar" style="width: 50%;border-right: 1px solid #aaa;background-color:white;min-height: 10px; height: 15px"></div>
                <div class="clearfix"> </div>

                <!-- Color Bar -->
                <div class="span12 pd-vb-bar">
                    <!-- Green Yes Bar -->
                    <div id="pd-vb-yes" class="" style="width: 46%;">
                    </div>
                    <div id="pd-vb-abstain" class="text-center" style="width: 1%;">
                    </div>
                    <!-- Red No Bar -->
                    <div id="pd-vb-no" class="" style="width: 53%;">
                    </div>
                </div>
                <div class="clearfix"> </div>

                <!-- Text Bar -->
                <div class="">
                    <!-- Green Yes Bar -->
                    <div id="pd-vb-yes-text" class="pd-vb-text" style="width: 33.3%; visibility: visible;">
                        <div class="pd-vb-text-yes pd-color-yes">
                            JA
                        </div>
                        <div class="pd-vb-text-yes-numbers">
                            <ul class="unstyled pd-vb-numbers pd-color-yes">
                                <li class="pd-vb-yes-percent">45.9%</li>
                                <li class="pd-vb-yes-number">85</li>
                            </ul>
                        </div>
                    </div>
                    <!-- Gray Abstain Bar -->
                    <div id="pd-vb-abstain-text" class="text-center pd-vb-text" style="width: 33.3%; visibility: visible;">
                        <div class="pd-vb-text-abstain-container">
                            <div class="pd-vb-text-abstain pd-color-abstain">
                                ENTH
                            </div>
                            <div class="pd-vb-text-yes-numbers">
                                <ul class="unstyled pd-vb-numbers pd-color-abstain">
                                    <li class="pd-vb-abstain-percent">1.1%</li>
                                    <li class="pd-vb-abstain-number" class="pull-left">2</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Red No Bar -->
                    <div id="pd-vb-no-text" class="pd-vb-text" style="width: 33.3%; visibility: visible;">
                        <div class="pd-vb-text-no pd-color-no text-left">
                            NEIN
                        </div>
                        <div class="pd-vb-text-no-numbers pd-color-no">
                            <ul class="unstyled pd-vb-numbers pull-right">
                                <li class="pd-vb-no-percent">53.0%</li>
                                <li class="pd-vb-no-number">98</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="clearfix"> </div>

                <!-- Significations -->
                <div id="pd-vb-details-container">
                  <div id="pd-vb-sign-yes" class="span6 text-left pd-color-yes"> JA stimmen bedeutet:</div>
                  <div id="pd-vb-sign-no" class="span6 text-right pd-color-no"> NEIN stimmen bedeutet:</div>
                  <div class="clearfix"> </div>

                  <div id="pd-vb-sign-yes-details" class="span6 text-left pd-color-yes"></div>
                  <div id="pd-vb-sign-no-details" class="span6 text-right pd-color-no"></div>
                </div>
                <div class="clearfix"> </div>

            </div>
       	

	<div class="chart" id="details-party"><h2>Verhalten der Fraktion</h2></div><!-- Abstimmungsverhalten -->


  <div class="chart" id="details-gender"><h2>Verhalten der Geschlechter</h2></div>


  <div class="chart" id="details-age"><h2>Verhalten der Altersklassen</h2></div>


  <div class="chart" id="details-district"><h2>Verhalten der Bezirke</h2></div>

<div class="clearfix"> </div>

<h2 class="pd-color-yes"><span class="title-detail pd-vb-yes-number"></span> haben JA gestimmt</h2>
<table class="details" id="details-yes"></table>

<h2 class="pd-color-no"><span class="title-detail pd-vb-no-number"></span> haben NEIN gestimmt</h2>
<table class="details" id="details-no"></table>

<h2 class="pd-color-abstain"><span class="title-detail pd-vb-abstain-number"></span> haben sich enthalten</h2>
<table class="details" id="details-abstain"></table>

<h2 class="pd-color-abstain"><span class="title-detail pd-vb-novote-number"></span> haben nicht abgestimmt </h2>
<p> Aus den offiziellen Daten geht nicht hervor, ob diese Personen entschuldigt oder abwesend waren. Oder ob sie aus anderen Gr√ºnden nicht an der Abstimmung teilgenommen haben. Die Pr√§sidentin oder der Pr√§sident des Verfassungsrates stimmt nicht ab, ausser das Abstimmungsresultat ist unentschieden.  
<table class="details" id="details-novote"></table>



<div class="vote-metadata lower"></div>
<div><a id="download" class="link" href="">Abstimmungsdaten herunterladen</a></div>

</div>
<div class="footer">
  <div style="float:right"><img src="img/logo-blanc.png" width="64px" height="64px"/></div>
    <div>Umsetzung - Florian Ev√©quoz, 2020-21</div>
    <!--<div>Photo d'ent√™te, Patrick Hofer, Flickr, CC-BY</div>-->
    <div>Quellcode <a href="https://github.com/evequozf/qui-vote-quoi" class="link">https://github.com/evequozf/qui-vote-quoi</a></div>
</div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    

<script>

/****************************************************************/

//AFFAIRVOTEID = "20200904113904"

QUIVOTEQUOI_WEBSITE = "http://www.quivotequoi.ch/"
WERSTIMMTWIE_WEBSITE = "http://www.werstimmtwie.ch/"

//20200903154222

const urlParams = new URLSearchParams(window.location.search);
const AFFAIRVOTEID = urlParams.get('affairVoteId');
const VOTEDESCRIPTION = urlParams.get('voteDescription');

const csvMetadataFile = QUIVOTEQUOI_WEBSITE+"votes/Tous votes Constituante - Sheet1.csv"
const csvVoteFile = QUIVOTEQUOI_WEBSITE+"votes/"+AFFAIRVOTEID+".csv"

//2021 ---- fetch votes explicitely from quivotequoi.ch ?
//const csvMetadataFile = "www.quivotequoi.ch/votes/Tous votes Constituante - Sheet1.csv"
//const csvVoteFile = "www.quivotequoi.ch/votes/"+AFFAIRVOTEID+".csv"


// valeur du vote dans fichier CSV
const VOTE_OUI = "Oui/Ja"
const VOTE_NON = "Non/Nein"
const VOTE_ABST = "Abst./Enth."
const VOTE_NOVOTE = "Aucun/Keine"

// Valable seulement pour Constituante ! Partis dans l'ordre droite-gauche pour graphique
var partisOrder = [
  "LES VERTS",
  "AdG",
  "ZUK-VS",
  "AC",
  "CSPO",
  "CVPO",
  "PDC",
  "VLR",
  "UDC",
  "SVPO"
]

var partisOrder2021 = [ // FIX2021 : ajout INDEP pour Gerhard
  "LES VERTS",
  "AdG",
  "ZUK-VS",
  "AC",
  "INDEP",
  "CSPO",
  "CVPO",
  "PDC",
  "VLR",
  "UDC",
  "SVPO"
]

var partisOrder2022 = [ // FIX2022 : chg noms des partis
  "LES VERTS",
  "PS-GC",
  "ZUK-VS",
  "AC",
  "CSPO",
  "Die Mitte Oberwallis",
  "Le Centre",
  "VLR",
  "UDC",
  "SVPO"
]

const districtsOrder = [
  "Goms",
  "Brig",
  "√ñstlich Raron",
  "Westlich Raron",
  "Visp",
  "Leuk",
  "Sierre",
  "Sion",
  "H√©rens",
  "Conthey",
  "Entremont",
  "Martigny",
  "St-Maurice",
  "Monthey"
]

//console.log(urlParams)

// ALLEMAND - changer les champs 
// champs concern√©s : DE_meaningYesText DE_meaningNoText  DE_affair DE_section  DE_note DE_warning  DE_attachment
function convertGermanFields(row) {
  row.meaningYesText = row.DE_meaningYesText;
  row.meaningNoText = row.DE_meaningNoText;  
  row.affair = row.DE_affair;
  row.section = row.DE_section;
  row.note = row.DE_note; 
  row.warning = row.DE_warning;  
  row.attachment = row.DE_attachment
  row.meaningYes == "Zustimmen"
  row.meaningNo = "Ablehnen" 
  return row;
}

// ALLEMAND - changer les champs 
function convertGermanFieldsVotes(row) {
  row.Genre = (row.Genre == "H") ? "M" : row.Genre;
  return row;
}
// ALLEMAND - changer les champs
// ALLEMAND - changer les champs


d3.csv(csvMetadataFile, convertGermanFields).then(d => loadMetadata(d)) 
d3.csv(csvVoteFile, convertGermanFieldsVotes).then(d => {

  /// FIX2021 - FIX2022 : starting from 2021 new group ! INDEP + 2022 new group names
  console.log(csvVoteFile)
  if (csvVoteFile.startsWith(QUIVOTEQUOI_WEBSITE+"votes/2021")) {
    partisOrder = partisOrder2021
  } else if (csvVoteFile.startsWith("votes/2022") || csvVoteFile.startsWith("votes/2023"))  {
    partisOrder = partisOrder2022
  } 
  // END FIX2021 - FIX2022

  fillTables(d);
  chart("#details-party", d, (d => d.group));
  infotext("#details-gender", d); //FIXME : pas convaincant
  chart("#details-gender", d, (d => d.Genre));
  chart("#details-district", d, (d => d.District));
  // wrangle -> classes d'√¢ge
  d.forEach(dd => {
    if(dd.√Çge < 30) {
      dd.classe = "18-30"
    } else if (dd.√Çge < 45) {
      dd.classe = "30-45"
    } else if (dd.√Çge < 65) {
      dd.classe = "45-65"
    } else {
      dd.classe = "65+"
    }
  });
  chart("#details-age", d, (d => d.classe));
})



var data


// set the dimensions and margins of the graph
var margin = {top: 10, right: 10, bottom: 50, left: 20},
    width = 400 - margin.left - margin.right,   // 460 ok screen, 380 portable
    height = 200 - margin.top - margin.bottom;


var fullMetadata;

// Charger fichier de metadata et setter les donn√©es du vote + r√©sultat global
function loadMetadata(d) {

  fullMetadata = d;

	var vote = d.filter(dd => dd.affairVoteId == AFFAIRVOTEID)[0]

  /* Link to navigate previous and next vote */
  // WARNING ! DEPENDS ON SORTING of metadata file -> be smart to see if it's ascending or descending
  //"#previousVote" "#nextVote"
  var previousVoteId = -1, nextVoteId = -1, tmp=0;
  for(var i=0; i < d.length; i++) {
    if(d[i].affairVoteId == AFFAIRVOTEID)¬†{
      previousVoteId = (i>0) ? d[i-1].affairVoteId : d[0].affairVoteId;
      nextVoteId = (i<d.length-1) ? d[i+1].affairVoteId : d[d.length-1].affairVoteId;
    }
  }
  //check if previous is really "chronologically" previous, if not, swap
  if(previousVoteId > nextVoteId) {
    tmp = previousVoteId; 
    previousVoteId = nextVoteId;
    nextVoteId = tmp
  }
  // set links
  d3.select("#previousVote").attr("href",window.location.pathname
      +"?affairVoteId="+previousVoteId
      + (VOTEDESCRIPTION ? "&voteDescription=true" : ""))
  d3.select("#nextVote").attr("href",window.location.pathname
      +"?affairVoteId="+nextVoteId
      + (VOTEDESCRIPTION ? "&voteDescription=true" : ""))

  // set languages links
  d3.select("#language-fr").attr("href",QUIVOTEQUOI_WEBSITE+"vote.html"
      +"?affairVoteId="+AFFAIRVOTEID
      + (VOTEDESCRIPTION ? "&voteDescription=true" : ""))
  d3.select("#language-de").attr("href",WERSTIMMTWIE_WEBSITE+"abstimmung.html"
      +"?affairVoteId="+AFFAIRVOTEID
      + (VOTEDESCRIPTION ? "&voteDescription=true" : ""))


  /* Header page title */
  if (vote.label) {
    /* Header html page title */
    window.document.title = vote.label;
    /* Page title */
    d3.select("h1#affair").text(vote.label)
    /* Signification oui-non */
    d3.select("#pd-vb-sign-yes").text("JA stimmen bedeutet : '"+vote.meaningYes+"'")
    d3.select("#pd-vb-sign-no").text("NEIN stimmen bedeutet : '"+vote.meaningNo+"'")
  }

  /* If ?voteDescription=true in URL */
  if (VOTEDESCRIPTION) {
    /* Header html page title */
    if(vote.affair) {
      window.document.title = vote.affair;
    } 
    /* Page title */
    d3.select("h1#affair").text(vote.affair)
    /* Note */
    d3.select("#note").html(vote.note);
    /* Mise en garde, si le vote est contre-intuitif */
    if (vote.warning) {
      d3.select("#warning").style("display","block");
      d3.select("#warning-text").html(vote.warning);
    }
    /* Signification oui-non - amendement complet */
    d3.select("#pd-vb-sign-yes-details").html(vote.meaningYesText)
    d3.select("#pd-vb-sign-no-details").html(vote.meaningNoText)

    /* Signification oui-non */
    d3.select("#pd-vb-sign-yes").text("JA stimmen bedeutet: " + (vote.meaningYesText ? "" : ("'"+vote.meaningYes) +"'"))
    d3.select("#pd-vb-sign-no").text("NEIN stimmen bedeutet: " + (vote.meaningNoText ? "" : ("'"+vote.meaningNo) +"'"))
  }

  

  /* M√©tadonn√©es officielles (titre, label, etc.) */
  var meta = d3.selectAll(".vote-metadata")
  meta.append("div").text("Offizieller Hinweis zur Abstimmung: ")
    .append("span").attr("class","label").text("\""+vote.label+"\"")
  meta.append("div").attr("class","attachment").text("Details zu den Artikeln und Ab√§nderungsantr√§gen: ")
    .append("a")
      .attr("class","link refdoc")
      .text(vote.attachment);
  d3.selectAll("a.link.refdoc")
      .attr("href",QUIVOTEQUOI_WEBSITE+"attachments/"+vote.attachment); // also link in "note" introductory text
  
  // M√©tadata - only in "lower" metadata
  meta = d3.select(".vote-metadata.lower")
  meta.append("div").text("Session: "+vote.section)
  meta.append("div").text("Video zu den Debatten: "+vote.linkVideo)
  meta.append("div").text("Datum und Zeit: "+vote.startTime)

  /* Download link of raw results */
  d3.select("#download").attr("href",csvVoteFile);

	/* R√©sultat g√©n√©ral */
	total = 1.0 * (parseInt(vote.numAbst) + parseInt(vote.numYes) + parseInt(vote.numNo))
	//console.log(total)
	values = {
		"yesPercent":100*(vote.numYes/total),
		"noPercent":100*(vote.numNo/total),
		"abstainPercent":100*(vote.numAbst/total),
		"yesNum":vote.numYes,
		"noNum":vote.numNo,
		"abstainNum":vote.numAbst
	}

	for (var v of ["yes","no","abstain"]) {
		d3.select("#pd-vb-"+v).style("width",values[v+"Percent"]+"%")
		d3.selectAll(".pd-vb-"+v+"-percent").text(Math.round(values[v+"Percent"]*10)/10+"%")
		d3.selectAll(".pd-vb-"+v+"-number").text(values[v+"Num"])
	}

	d3.select(".pd-vb-novote-number").text(130-total)

  if(vote.numYes > vote.numNo) {
    d3.select(".pd-vb-text-yes").classed("pd-win",true)
  } else {
    d3.select(".pd-vb-text-no").classed("pd-win",true)
  }

  /* Show-hide help on how to interpret vote */
  d3.select("#help").style("display","none"); 
  d3.select("#toggle-help").on("click", function() {
      var el = d3.select("#help");
      var visible = !(el.node().offsetParent === null); // check if element is visible or not
      d3.select("#help").style("display", visible ? "none" : "block");
      d3.select("#toggle-help")
        .attr("class", visible ?  null : "alt")
        .text(visible ?  "Interpretation dieser Abstimmung" : "Ich habe verstanden!");
   })

	//console.log(values)
}


/* Afficher nombre de femmes par groupe */ // FIXME : pas convaincant, √† g√©n√©raliser aux autres graphes ?
function infotext(containerId, data) {
  var n = d3.nest()
    .key(d => d.group)
    .key(d => d.Genre)
    .rollup(l => l.length)
    .entries(data)
  
  if (partisOrder) {
    n.sort((a,b) => partisOrder.indexOf(a.key) < partisOrder.indexOf(b.key));
  }
  
  /* create table of details */
  var div = d3.select(containerId)
    .append("div").attr("class","infotext");
  var table = div.append("table");
  var thead = table.append("thead").append("tr");
  thead.append("th").text("Fraktion");
  thead.append("th").text("Frauen");
  thead.append("th").text("M√§nner");
  var trs = table.append("tbody").selectAll("tr").data(n).enter().append("tr")
  trs.html(d => {
      var f = 0, h=0;
      d.values.forEach(v => {
        if (v.key=="F")
          f = v.value;
        else if (v.key=="M")
          h = v.value;
      });
      return "<td>"+d.key+"</td><td>"+f+"</td><td>"+h+"</td>";
    });

   // hide-show details on click
   d3.select(containerId + " h2").html(d3.select(containerId + " h2").text()+"<span class=\"info\"> (‚Ñπ)</span>") 
   d3.select(containerId + " h2 span").on("click", function() {
      var el = d3.select(containerId + " div.infotext");
      var visible = !(el.node().offsetParent === null); // check if element is visible or not
      d3.select(containerId + " div.infotext").style("display", visible ? "none" : "block");
   })
}



/***************************************/

var fullStackedData

function chart(containerId, data, groupByFunc) {

	//data = d;

/* chart with votes for each party */

	//wrangle data to get number of yes/no/abst per group
	var n = d3.nest()
		.key(groupByFunc)
		.key(d => d.vote)
		.rollup(l => l.length)
		.entries(data)

	var tab = []
	n.forEach(t => {
		_group = t.key;
		_yes = 0;
		_no = 0;
		_abst = 0;
		t.values.forEach(tt => {
			if (tt.key == VOTE_NON)
				_no = tt.value
			else if (tt.key == VOTE_OUI)
				_yes = tt.value
			else if (tt.key == VOTE_ABST)
				_abst = tt.value
		})
		tab.push({group:_group, yes:_yes, no:_no, abst:_abst, tot:(_yes+_no+_abst)})
	})


  // List of possibles votes (= keys in 'tab')
  var votes = ["yes", "no", "abst"]

  // List of groups 
  var groups = d3.map(tab, (d => d.group)).keys()
  groups.sort(d3.ascending)

  // groupes dans l'ordre droite-gauche FIXME : ENLEVER pour Grand Conseil ??
  if (containerId=="#details-party" && partisOrder) {
 	  groups = partisOrder
  }

  // districts dans l'ordre
  if (containerId=="#details-district" && districtsOrder) {
    groups = districtsOrder
  }

  // append the svg object to the body of the page
  var svg = d3.select(containerId)
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

  // Add X axis
  var x = d3.scaleBand()
      .domain(groups)
      .range([0, width])
      .padding([0.4])
  const xAxis = svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x).tickSizeOuter(0));

  xAxis.selectAll(".domain, .tick line").remove();

  if(containerId=="#details-district" || containerId=="#details-party") {  /// FIX2021 : rotate axis labels also for #details-partx
    xAxis.selectAll("text")
      .attr("x", -3)
      .attr("y", 3)
      .attr("text-anchor", "end")
      .attr("transform", "rotate(-30)");
  }

  // Add Y axis
  var y = d3.scaleLinear()
    .domain([0, d3.max(tab.map(t => t.tot))])
    .range([ height, 0 ]);
  svg.append("g")
    .call(d3.axisLeft(y));

  // color palette = one color per vote
  var color = d3.scaleOrdinal()
    .domain(votes)
    .range(['#5da13c','#ce4141','#555'])

  //stack the data? --> stack per vote
  var stackedData = d3.stack().keys(votes)(tab)

  //console.log(stackedData)
  //fullStackedData = stackedData

  // Show the bars
  var bars = svg.append("g")
    .selectAll("g")
    // Enter in the stack data = loop key per key = group per group
    .data(stackedData)
    .enter().append("g")
      .attr("fill", function(d) { return color(d.key); })
      .selectAll("rect")
      // enter a second time = loop subgroup per subgroup to add all rectangles
      .data(function(d) { return d; })
      .enter();

  bars.append("rect")
        .attr("x", function(d) { return x(d.data.group); })
        .attr("y", function(d) { return y(d[1]); })
        .attr("height", function(d) { return y(d[0]) - y(d[1]); })
        .attr("width",x.bandwidth())

  // FIXME !! -> label dans les barres
  
  bars.append("text")
    .text(function(d) { var v = (d[1]-d[0]); return v > 0 ? v : ""; } )
    .attr("y", function(d) { return y(d[1])+(y(d[0]) - y(d[1]))/2; })
    .attr("x", function(d) { return x(d.data.group) + x.bandwidth()/2; })
    .attr("class","rect-label");
    //.style("fill", 'black');

  bars.append("text")
    .text(function(d) { var v = (d[1]-d[0]); return v > 0 ? v : ""; } )
    .attr("y", function(d) { return y(d[1])+(y(d[0]) - y(d[1]))/2; })
    .attr("x", function(d) { return x(d.data.group) + x.bandwidth()/2; })
    .attr("class","rect-label-front");
  
}


/* table with individual votes ! */
function fillTables(data){
	fillTable("#details-yes", data.filter(d => d.vote==VOTE_OUI))
	fillTable("#details-no", data.filter(d => d.vote==VOTE_NON))
	fillTable("#details-abstain", data.filter(d => d.vote==VOTE_ABST))
	fillTable("#details-novote", data.filter(d => d.vote==VOTE_NOVOTE))
}

function fillTable(tableId, data) {
	var table = d3.select(tableId);
	table.attr("class", "stripe compact")
  
	var thead = table.append("thead").append("tr");
		thead.append("th").text("Name");
		thead.append("th").text("Fraktion");
    thead.append("th").text("Bezirk");
		thead.append("th").html("Abstimmung");

	//create rows based on data
	var tbody = table.append("tbody");
	var rows = tbody.selectAll("tr")
		.data(data)
		.enter().append("tr");
	var names = rows.append("td").text(d => d.name);
	var partis = rows.append("td").text(d => d.group);
  var districts = rows.append("td").text(d => d.District);
	var votes = rows.append("td").text(d => d.vote);

	$(tableId).DataTable({
		"paging":   false,
        "info":     false,
        "searching": 	false,
        "order": [[ 1, "asc" ]],
        "oLanguage": {
          "sSearch": "Suchen:"
        }
    });
}




</script>
</body>
</html>